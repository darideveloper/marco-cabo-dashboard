flowchart TD
    Start([User Starts Booking]) --> InitialForm[Initial Form]
    
    InitialForm --> CollectBasic[Collect Basic Info:<br/>- Service Type<br/>- Client Name<br/>- Client Email<br/>- Location<br/>- Vehicle]
    
    CollectBasic --> SubmitInitial[Submit to SaleViewSet POST]
    
    SubmitInitial --> ValidateInitial{Validate<br/>SaleSerializer}
    
    ValidateInitial -->|Invalid| ErrorInitial[Return Error Response<br/>400 Bad Request]
    ErrorInitial --> InitialForm
    
    ValidateInitial -->|Valid| CreateClient[Create Client Record<br/>with name & email]
    
    CreateClient --> GenerateUUID[Generate Unique stripe_code<br/>UUID for sale security]
    
    GenerateUUID --> GetPricing[Get Pricing from DB<br/>location + vehicle + service_type]
    
    GetPricing --> CreateSale[Create Sale Record:<br/>- stripe_code UUID<br/>- total from pricing<br/>- paid = False<br/>- Link client]
    
    CreateSale --> GeneratePayment[Generate Stripe Payment Link<br/>with sale details and stripe_code]
    
    GeneratePayment --> ReturnPayment[Return Response:<br/>- sale_id<br/>- payment_link<br/>201 Created]
    
    ReturnPayment --> UserRedirect[User Redirected to Stripe<br/>Payment Page]
    
    UserRedirect --> StripeProcess[User Completes Payment<br/>on Stripe]
    
    StripeProcess --> StripeValidation{Stripe Validates<br/>Payment}
    
    StripeValidation -->|Payment Failed| PaymentFailed([Payment Failed<br/>No Redirect])
    
    StripeValidation -->|Payment Successful| StripeRedirect[Stripe Redirects ONLY on Success<br/>to /confirmation/stripe_code]
    
    StripeRedirect --> AfterPaymentForm[After Payment Form<br/>User sees confirmation page<br/>with stripe_code in URL]
    
    AfterPaymentForm --> CollectDetails[Collect Additional Info:<br/>- Client Last Name<br/>- Client Phone<br/>- Passengers Count<br/>- Additional Details<br/>- Arrival Transfer Info<br/>- Departure Transfer Info if Round Trip]
    
    CollectDetails --> SubmitDone[Submit to SaleDoneView POST<br/>with sale_stripe_code]
    
    SubmitDone --> ValidateDone{Validate<br/>SaleDoneSerializer}
    
    ValidateDone -->|Invalid| ErrorDone[Return Error Response<br/>400 Bad Request]
    ErrorDone --> AfterPaymentForm
    
    ValidateDone -->|Valid| FindSale{Find Sale by<br/>stripe_code}
    
    FindSale -->|Not Found| Unauthorized[Return Error<br/>401 Unauthorized]
    
    FindSale -->|Found| CheckPaid{Check if<br/>sale.paid == True}
    
    CheckPaid -->|Already Paid| AlreadyPaid[Return Error<br/>Sale Already Paid<br/>400 Bad Request]
    
    CheckPaid -->|Not Paid Yet| UpdateClient[Update Client:<br/>- name<br/>- last_name<br/>- phone]
    
    UpdateClient --> UpdateSale[Update Sale:<br/>- passengers<br/>- details<br/>- paid = True]
    
    UpdateSale --> CreateArrival[Create Arrival Transfer:<br/>- type = arrival<br/>- date, hour<br/>- airline, flight_number]
    
    CreateArrival --> CheckRoundTrip{Service Type =<br/>Round Trip?}
    
    CheckRoundTrip -->|No| Success[Return Success Response<br/>Sale Confirmed<br/>200 OK]
    
    CheckRoundTrip -->|Yes| CreateDeparture[Create Departure Transfer:<br/>- type = departure<br/>- date, hour<br/>- airline, flight_number]
    
    CreateDeparture --> Success
    
    Success --> End([Booking Complete])
    
    SecurityNote1[Security: stripe_code is UUID<br/>generated by backend not Stripe]
    SecurityNote2[Security: Stripe only redirects<br/>on successful payment]
    SecurityNote3[Security: Duplicate submission<br/>blocked by paid check]
    
    GenerateUUID -.->|Security Layer| SecurityNote1
    StripeRedirect -.->|Security Layer| SecurityNote2
    CheckPaid -.->|Security Layer| SecurityNote3
    
    style Start fill:#e1f5e1
    style End fill:#e1f5e1
    style InitialForm fill:#fff4e6
    style AfterPaymentForm fill:#fff4e6
    style ErrorInitial fill:#ffe6e6
    style ErrorDone fill:#ffe6e6
    style Unauthorized fill:#ffe6e6
    style PaymentFailed fill:#ffe6e6
    style AlreadyPaid fill:#ffe6e6
    style Success fill:#e6f3ff
    style ReturnPayment fill:#e6f3ff
    style GenerateUUID fill:#f0e6ff
    style CheckPaid fill:#f0e6ff
    style StripeValidation fill:#fff9e6
    style SecurityNote1 fill:#e6ffe6
    style SecurityNote2 fill:#e6ffe6
    style SecurityNote3 fill:#e6ffe6